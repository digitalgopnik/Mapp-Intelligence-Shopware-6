{% sw_extends '@Storefront/storefront/layout/meta.html.twig' %}

{% block layout_head_meta_tags_charset %}
    {{ parent() }}
    {% block ti_loader_snippet %}
        <script type="text/javascript">
            window._tiConfig = window._tiConfig || {
                tiDomain: "{{ mappIntelligence.tiDomain|sw_sanitize }}",
                tiId: "{{ mappIntelligence.tiId|sw_sanitize }}",
                option: {}
            };
            (function(a,d,c,f){a.wts=a.wts||[];var g=function(b){var a="";b.customDomain&&b.customPath?a=b.customDomain+"/"+b.customPath:b.tiDomain&&b.tiId&&(a=b.tiDomain+"/resp/api/get/"+b.tiId+"?url="+encodeURIComponent("https://"+d.location.host+"/")+"&v=5");if(b.option)for(var c in b.option)a+="&"+c+"="+encodeURIComponent(b.option[c]);return a};if(-1===d.cookie.indexOf("wt_r=1")){var e=d.getElementsByTagName(c)[0];c=d.createElement(c);c.async=!0;c.onload=function(){if("undefined"!==typeof a.wt_r&&!isNaN(a.wt_r)){var b=
                new Date,c=b.getTime()+1E3*parseInt(a.wt_r);b.setTime(c);d.cookie="wt_r=1;path=/;expires="+b.toUTCString()}};c.onerror=function(){"undefined"!==typeof a.wt_mcp_hide&&"function"===typeof a.wt_mcp_hide.show&&(a.wt_mcp_hide.show(),a.wt_mcp_hide.show=function(){})};c.src="//"+g(f);e.parentNode.insertBefore(c,e)}})(window,document,"script",_tiConfig);
        </script>
    {% endblock %}

    {% block _ti %}
        <script>
            window._ti = {};
            {% if mappInclude('pageName') %}window._ti.pageName = location.host + location.pathname;{% endif %}
            {% if mappInclude('customerId') %}window._ti.customerId = '{{ context.customer.uniqueIdentifier }}';{% endif %}
            {% if mappInclude('eMailSubscription') %}window._ti.eMailSubscription = '{{ context.customer.newsletter ? 'true' : 'false' }}';{% endif %}
            {% if mappInclude('currency') %}window._ti.currency = '{{ context.currency.isoCode }}';{% endif %}

            {% if activeRoute == 'frontend.navigation.page' %}
                {% if mappInclude('contentCategory') %}window._ti.contentCategory = 'Content';{% endif %}
                {% if mappInclude('pageTitle') %}window._ti.pageTitle = '{{ page.cmsPage.name }}';{% endif %}
                {% if page.cmsPage.type == 'landingpage' %}
                    {% if mappInclude('contentSubCategory') %}window._ti.contentSubCategory = 'Landing Page';{% endif %}
                {% endif %}
            {% endif %}

            {% if activeRoute == 'frontend.search.page' %}
            {% if mappInclude('contentCategory') %}window._ti.contentCategory = 'Catalogue';{% endif %}
            {% if mappInclude('contentSubcategory') %}window._ti.contentSubcategory = 'Internal Search';{% endif %}
            {% if mappInclude('searchTerm') %}window._ti.searchTerm = '{{ page.searchTerm }}';{% endif %}
            {% if mappInclude('numberOfSearchResults') %}window._ti.numberOfSearchResults = '{{ page.searchResult.total }}';{% endif %}
            {% endif %}

            {% if activeRoute == 'frontend.detail.page' %}
                {% if mappInclude('contentCategory') %}window._ti.contentCategory = 'Catalogue';{% endif %}
                {% if mappInclude('contentSubcategory') %}window._ti.contentSubcategory = 'Product Detail';{% endif %}
                {% if mappInclude('productCost') %}window._ti.productCost = '{{ page.product.calculatedListingPrice.to.unitPrice }}';{% endif %}
                {% if mappInclude('productId') %}window._ti.productId = '{{  page.product.productNumber }}';{% endif %}
                {% if mappInclude('productShopwareId') %}window._ti.productShopwareId = '{{  page.product.id }}';{% endif %}
                {% if mappInclude('productName') %}window._ti.productName = '{{ page.product.translated.name }}';{% endif %}
                {% if mappInclude('productQuantity') %}window._ti.productQuantity = '1';{% endif %}
                {% if mappInclude('shoppingCartStatus') %}window._ti.shoppingCartStatus = 'view';{% endif %}
                {% if mappInclude('productCategories') %}window._ti.productCategories = JSON.parse('{{ getCategoryNames(page.product.categoryTree)|json_encode|raw }}');{% endif %}
                if(window._ti.productCategories && window._ti.productCategories[0]) {
                    {% if mappInclude('productCategory') %}window._ti.productCategory = window._ti.productCategories[0];{% endif %}
                }
                if(window._ti.productCategories && window._ti.productCategories[1]) {
                    {% if mappInclude('productSubCategory') %}window._ti.productSubCategory = window._ti.productCategories[1];{% endif %}
                }
            {% endif %}
            {% if activeRoute == 'frontend.checkout.finish.page' %}
                {% if mappInclude('contentCategory') %}window._ti.contentCategory = 'Checkout';{% endif %}
                {% if mappInclude('shoppingCartStatus') %}window._ti.shoppingCartStatus = 'conf';{% endif %}
                {% if mappInclude('orderId') %}window._ti.orderId = '{{ page.order.orderNumber }}';{% endif %}
                {% if mappInclude('totalOrderValue') %}window._ti.totalOrderValue = '{{ page.order.amountTotal }}';{% endif %}
                {% if mappInclude('products') %}window._ti.products = [];{% endif %}


                    {% for product in page.order.lineItems %}
                        if(window._ti.products) {
                            window._ti.products[{{ loop.index0 }}] = {};
                            {% if mappInclude('productCost') %}window._ti.products[{{ loop.index0 }}].productCost = "{{ product.price.unitPrice }}";{% endif %}
                            {% if mappInclude('productId') %}window._ti.products[{{ loop.index0 }}].productId = "{{ product.payload.productNumber }}";{% endif %}
                            {% if mappInclude('productShopwareId') %}window._ti.products[{{ loop.index0 }}].productShopwareId = "{{ product.productId }}";{% endif %}
                            {% if mappInclude('productName') %}window._ti.products[{{ loop.index0 }}].productName = "{{ product.label }}";{% endif %}
                            {% if mappInclude('productQuantity') %}window._ti.products[{{ loop.index0 }}].productQuantity = "{{ product.quantity }}";{% endif %}
                            {% if mappInclude('productCategories') %}window._ti.products[{{ loop.index0 }}].productCategories = JSON.parse('{{ getCategoryNames(product.payload.categoryIds)|json_encode|raw }}');{% endif %}
                        }
                    {% endfor %}
            (function(){
                var productKeys = (function(obj) {
                    var r = [];
                    for (var k in obj) {
                        if (!obj.hasOwnProperty(k)) {
                            continue;
                        }
                        r.push(k);
                    }
                    return r;
                })(_ti.products[0]);
                for(var i = 0; i < productKeys.length; i++) {
                    var productKey = productKeys[i];
                    window._ti[productKey] = '';
                    for(var j = 0; j < window._ti.products.length; j++) {
                        var product = window._ti.products[j];
                        if(typeof product[productKey] === 'string') {
                            window._ti[productKey] += (j > 0 ? ';': '') + product[productKey];
                        } else if(Object.prototype.toString.call(product[productKey]) === "[object Array]") {
                            window._ti[productKey] = window._ti[productKey] || [];
                            var maxLength = (function(products) { //
                                var maxLength = 0;
                                for(var k = 0; k < products.length; k++) {
                                    if(maxLength < products[k][productKey].length) {
                                        maxLength = products[k][productKey].length;
                                    }
                                }
                                return maxLength;
                            })(window._ti.products);
                            if(j === 0) {
                                for(var k = 0; k < maxLength; k++) { //init
                                    window._ti[productKey][k] = '';
                                }
                            }
                            for(k = 0; k < maxLength; k++) { // add values
                                window._ti[productKey][k] = window._ti[productKey][k] +
                                    (j > 0 ? ';' : '') +
                                    (product[productKey][k] !== undefined ? product[productKey][k] : '');
                            }
                        }
                    }
                }
            })();
            if(window._ti.productCategories && window._ti.productCategories[0]) {
                {% if mappInclude('productCategory') %}window._ti.productCategory = window._ti.productCategories[0];{% endif %}
            }
            if(window._ti.productCategories && window._ti.productCategories[1]) {
                {% if mappInclude('productSubCategory') %}window._ti.productSubCategory = window._ti.productCategories[1];{% endif %}
            }
            {% endif %}


        </script>

{#        {{ dump() }}#}
    {% endblock %}
{% endblock %}
