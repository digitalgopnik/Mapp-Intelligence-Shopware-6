{% sw_extends '@Storefront/storefront/layout/meta.html.twig' %}

{% block layout_head_meta_tags_charset %}
    {{ parent() }}
    {% block ti_loader_snippet %}
        <script type="text/javascript">
            window._tiConfig = window._tiConfig || {
                tiDomain: "{{ mappIntelligence.tiDomain|sw_sanitize }}",
                tiId: "{{ mappIntelligence.tiId|sw_sanitize }}",
                option: {}
            };
            (function(a,d,c,f){a.wts=a.wts||[];var g=function(b){var a="";b.customDomain&&b.customPath?a=b.customDomain+"/"+b.customPath:b.tiDomain&&b.tiId&&(a=b.tiDomain+"/resp/api/get/"+b.tiId+"?url="+encodeURIComponent("https://"+d.location.host+"/")+"&v=5");if(b.option)for(var c in b.option)a+="&"+c+"="+encodeURIComponent(b.option[c]);return a};if(-1===d.cookie.indexOf("wt_r=1")){var e=d.getElementsByTagName(c)[0];c=d.createElement(c);c.async=!0;c.onload=function(){if("undefined"!==typeof a.wt_r&&!isNaN(a.wt_r)){var b=
                new Date,c=b.getTime()+1E3*parseInt(a.wt_r);b.setTime(c);d.cookie="wt_r=1;path=/;expires="+b.toUTCString()}};c.onerror=function(){"undefined"!==typeof a.wt_mcp_hide&&"function"===typeof a.wt_mcp_hide.show&&(a.wt_mcp_hide.show(),a.wt_mcp_hide.show=function(){})};c.src="//"+g(f);e.parentNode.insertBefore(c,e)}})(window,document,"script",_tiConfig);
        </script>
    {% endblock %}

    {% block _ti %}
        <script type="text/javascript">
            window._ti = {
                "pageName": {{ checkBlacklist('pageName', 'location.host + location.pathname')|raw }}
            }
        </script>
        {{ writeTiDataLayer([
            {key: 'customerId', value:  context.customer.uniqueIdentifier },
            {key: 'emailOptIn', value: context.customer.newsletter ? 'true' : 'false' },
            {key: 'currency', value: context.currency.isoCode },
        ])|raw }}
        {% if activeRoute == 'frontend.navigation.page' %}
            {{ writeTiDataLayer([
                {key: 'contentCategory', value:  'Content' },
                {key: 'pageTitle', value: page.cmsPage.name }
            ])|raw }}
            {% if page.cmsPage.type == 'landingpage' %}
                {{ writeTiDataLayer([
                    {key: 'contentSubCategory', value:  'Landing Page' }
                ])|raw }}
            {% endif %}
        {% endif %}

        {% if activeRoute == 'frontend.search.page' %}
            {{ writeTiDataLayer([
                {key: 'contentCategory', value:  'Catalogue' },
                {key: 'contentSubcategory', value: 'Internal Search' },
                {key: 'searchTerm', value: page.searchTerm },
                {key: 'numberOfSearchResults', value: page.searchResult.total }
            ])|raw }}
        {% endif %}

        {% if activeRoute == 'frontend.detail.page' %}
            {{ writeTiDataLayer([
                {key: 'contentCategory', value:  'Catalogue' },
                {key: 'contentSubcategory', value: 'Product Detail' },
                {key: 'productCost', value: page.product.calculatedListingPrice.to.unitPrice },
                {key: 'productId', value: page.product.productNumber },
                {key: 'productShopwareId', value: page.product.id },
                {key: 'productName', value:  page.product.translated.name },
                {key: 'productQuantity', value:  '1' },
                {key: 'shoppingCartStatus', value:  'view' },
                {key: 'productCategories', value:  getCategoryNames(page.product.categoryTree)|json_encode|raw, isJSON: 1 },
            ])|raw }}
            <script>
                if(window._ti.productCategories[0]) {
                    window._ti.productCategory = {{ checkBlacklist('productCategory', 'window._ti.productCategories[0]')|raw }};
                }
                if(window._ti.productCategories[1]) {
                    window._ti.productSubCategory = {{ checkBlacklist('productSubCategory', 'window._ti.productCategories[1]')|raw }};
                }
            </script>
        {% endif %}


        <script>
            {% if activeRoute == 'frontend.checkout.finish.page' %}
                window._ti.contentCategory = 'Checkout';
                window._ti.shoppingCartStatus = 'conf';
                window._ti.orderId = '{{ page.order.orderNumber }}';
                window._ti.totalOrderValue = '{{ page.order.amountTotal }}';
                window._ti.products = [
                    {% for product in page.order.lineItems %}
                        {
                            "productCost" : "{{ product.price.unitPrice }}",
                            "productId" : "{{ product.payload.productNumber }}",
                            "productShopwareId" : "{{ product.productId }}",
                            "productName" : "{{ product.label }}",
                            "productQuantity": "{{ product.quantity }}",
                            "productCategories": JSON.parse('{{ getCategoryNames(product.payload.categoryIds)|json_encode|raw }}')
                        }{% if loop.last == false %},{% endif %}
                    {% endfor %}
                ];
            (function(){
                var productKeys = (function(obj) {
                    var r = [];
                    for (var k in obj) {
                        if (!obj.hasOwnProperty(k)) {
                            continue;
                        }
                        r.push(k);
                    }
                    return r;
                })(_ti.products[0]);
                for(var i = 0; i < productKeys.length; i++) {
                    var productKey = productKeys[i];
                    window._ti[productKey] = '';
                    for(var j = 0; j < window._ti.products.length; j++) {
                        var product = window._ti.products[j];
                        if(typeof product[productKey] === 'string') {
                            window._ti[productKey] += (j > 0 ? ';': '') + product[productKey];
                        } else if(Object.prototype.toString.call(product[productKey]) === "[object Array]") {
                            window._ti[productKey] = window._ti[productKey] || [];
                            var maxLength = (function(products) { //
                                var maxLength = 0;
                                for(var k = 0; k < products.length; k++) {
                                    if(maxLength < products[k][productKey].length) {
                                        maxLength = products[k][productKey].length;
                                    }
                                }
                                return maxLength;
                            })(window._ti.products);
                            if(j === 0) {
                                for(var k = 0; k < maxLength; k++) { //init
                                    window._ti[productKey][k] = '';
                                }
                            }
                            for(k = 0; k < maxLength; k++) { // add values
                                window._ti[productKey][k] = window._ti[productKey][k] +
                                    (j > 0 ? ';' : '') +
                                    (product[productKey][k] !== undefined ? product[productKey][k] : '');
                            }
                        }
                    }
                }
            })();
            if(window._ti.productCategories[0]) {
                window._ti.productCategory = window._ti.productCategories[0];
            }
            if(window._ti.productCategories[1]) {
                window._ti.productSubCategory = window._ti.productCategories[1];
            }
            {% endif %}


        </script>

{#        {{ dump() }}#}
    {% endblock %}
{% endblock %}
